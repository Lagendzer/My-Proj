<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–≠–∫–æ–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>üåç –≠–∫–æ–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>
  </header>

  <nav>
    <button class="tablink active" onclick="openTab('pointsTab', this)">–ü—É–Ω–∫—Ç—ã –ø—Ä–∏—ë–º–∞</button>
    <button class="tablink" onclick="openTab('addPointTab', this)">–î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</button>
    <button class="tablink" onclick="openTab('reportsTab', this)">–û—Ç—á—ë—Ç—ã</button>
    <button class="tablink" onclick="openTab('addReportTab', this)">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
    <button class="tablink" onclick="openTab('vkladTab', this)">–í–∫–ª–∞–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    <button class="tablink" onclick="openTab('rankingTab', this)">–†–µ–π—Ç–∏–Ω–≥–æ–≤—ã–π –ª–∏—Å—Ç</button>
  </nav>

  <div id="pointsTab" class="tab active">
    <h2>üìå –ü—É–Ω–∫—Ç—ã –ø—Ä–∏—ë–º–∞</h2>
    <div id="points"></div>
  </div>

  <div id="rankingTab" class="tab">
    <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥–æ–≤—ã–π –ª–∏—Å—Ç</h2>
    <table>
      <thead>
        <tr>
          <th>–ú–µ—Å—Ç–æ</th>
          <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th>–í–∫–ª–∞–¥ (–∫–≥)</th>
        </tr>
      </thead>
      <tbody id="rankingTable"></tbody>
    </table>
  </div>

  <div id="addPointTab" class="tab">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç –ø—Ä–∏—ë–º–∞</h2>
    <input type="text" id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å">
    <button onclick="addPoint()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <span id="message"></span>
  </div>

  <div id="reportsTab" class="tab">
    <h2>üìã –í—Å–µ –æ—Ç—á—ë—Ç—ã</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th>–¢–∏–ø –æ—Ç—Ö–æ–¥–∞</th>
          <th>–ü—É–Ω–∫—Ç</th>
          <th>–í–µ—Å (–∫–≥)</th>
          <th>–î–∞—Ç–∞</th>
        </tr>
      </thead>
      <tbody id="reportTable"></tbody>
    </table>
  </div>
  

  <div id="addReportTab" class="tab">
    <h2>‚ôªÔ∏è –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç –æ–± —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏</h2>

    <input type="email" id="userEmail" placeholder="–ü–æ—á—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
    <select id="wasteType"></select>
    <select id="recyclingPoint"></select>
    <input type="number" id="weight" placeholder="–í–µ—Å (–∫–≥)" step="0.1">
    <input type="date" id="date">
    <button onclick="addReport()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
    <span id="reportMessage"></span>
    <button onclick="openAddWasteTypeModal()">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –æ—Ç—Ö–æ–¥–∞</button>
  </div>

  <div id="vkladTab" class="tab">
    <h2>üå± –≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≤–∫–ª–∞–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
    <input type="email" id="vkladEmail" placeholder="–ü–æ—á—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" list="emailList">
    <datalist id="emailList"></datalist>
    <button onclick="loadVklad()">–ü–æ—Å—á–∏—Ç–∞—Ç—å –≤–∫–ª–∞–¥</button>
    <p id="vkladResult"></p>
  </div>

  <footer>
    <button id="aboutProjectButton" onclick="openAboutProjectModal()">–û –ø—Ä–æ–µ–∫—Ç–µ</button>
  </footer>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—Ö–æ–¥–∞ -->
  <div id="addWasteTypeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAddWasteTypeModal()">&times;</span>
      <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –æ—Ç—Ö–æ–¥–∞</h2>
      <input type="text" id="newWasteType" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –æ—Ç—Ö–æ–¥–∞">
      <textarea id="newWasteDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ –æ—Ç—Ö–æ–¥–∞"></textarea>
      <button onclick="saveNewWasteType()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–û –ø—Ä–æ–µ–∫—Ç–µ" -->
  <div id="aboutProjectModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAboutProjectModal()">&times;</span>
      <h2>–û –ø—Ä–æ–µ–∫—Ç–µ</h2>
      <p>–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω –ú–µ—â–µ—Ä—è–∫–æ–≤—ã–º –û.–ê. –∏–∑ –≥—Ä—É–ø–ø—ã –ò–î–ë-22-09 —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –ú–ì–¢–£ "–°–¢–ê–ù–ö–ò–ù" –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —ç–∫–æ–ª–æ–≥–∏–∏. –° –ø–æ–º–æ—â—å—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–¥–∞—á—É –æ—Ç—Ö–æ–¥–æ–≤, —É—á–∏—Ç—ã–≤–∞—Ç—å –≤–∫–ª–∞–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—á–∏—Å—Ç–∫—É –ø–ª–∞–Ω–µ—Ç—ã –∏ –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!</p>
    </div>
  </div>
  
<!-- –î–û–ë–ê–í–¨ –í–ú–ï–°–¢–û –±–ª–æ–∫–∞ —Å <div id="chatModal" ...> –∏ <button ...> -->

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ -->
<div id="chatModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('chatModal').style.display='none'">&times;</span>
    <h2>üí¨ –ß–∞—Ç —Å –≠–∫–æ-–ë–æ—Ç–æ–º</h2>
    <div id="chatBox" style="height: 200px; overflow-y: auto; background: #222; padding: 10px; margin-bottom: 10px;"></div>
    <input type="text" id="userMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width: 80%;">
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button> <!-- –í–û–¢ –≠–¢–ê –ö–ù–û–ü–ö–ê! -->
  </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ -->
<button style="position: fixed; right: 20px; bottom: 20px; z-index: 999;" onclick="document.getElementById('chatModal').style.display='flex'">üí¨ –ß–∞—Ç</button>

<!-- –î–æ–±–∞–≤—å –≤ <script> –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º </body> -->
<script>
  async function sendMessage() {
    const input = document.getElementById("userMessage");
    const chatBox = document.getElementById("chatBox");
    const message = input.value.trim();
    if (!message) return;

    chatBox.innerHTML += `<p><strong>–í—ã:</strong> ${message}</p>`;
    input.value = "";

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });

      if (res.ok) {
        const data = await res.json();
        chatBox.innerHTML += `<p><strong>–ë–æ—Ç:</strong> ${data.reply}</p>`;
      } else {
        chatBox.innerHTML += `<p><strong>–ë–æ—Ç:</strong> –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞</p>`;
      }
    } catch (err) {
      chatBox.innerHTML += `<p><strong>–ë–æ—Ç:</strong> –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p>`;
    }

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  window.sendMessage = sendMessage; // –°–¥–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π
</script>


  <script>
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function openTab(tabId, btn) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tablink').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      btn.classList.add('active');
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'flex';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    function closeModal() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—Ö–æ–¥–∞
    function openAddWasteTypeModal() {
      openModal('addWasteTypeModal');
    }
	
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—Ö–æ–¥–∞
    function closeAddWasteTypeModal() {
      closeModal();
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ "–û –ø—Ä–æ–µ–∫—Ç–µ"
    function openAboutProjectModal() {
      openModal('aboutProjectModal');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ "–û –ø—Ä–æ–µ–∫—Ç–µ"
    function closeAboutProjectModal() {
      closeModal();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    async function loadPoints() {
      const res = await fetch('/api/points');
      const points = await res.json();
      const container = document.getElementById('points');
      const select = document.getElementById('recyclingPoint');
      container.innerHTML = '';
      select.innerHTML = '';
      points.forEach(p => {
        const div = document.createElement('div');
        div.className = 'point';
        div.innerHTML = `<strong>${p.–ù–∞–∑–≤–∞–Ω–∏–µ}</strong><br>${p.–ê–¥—Ä–µ—Å}`;
        container.appendChild(div);

        const opt = document.createElement('option');
        opt.value = p.ID;
        opt.textContent = p.–ù–∞–∑–≤–∞–Ω–∏–µ;
        select.appendChild(opt);
      });
    }

    async function loadWasteTypes() {
      const res = await fetch('/api/waste-types');
      const types = await res.json();
      const select = document.getElementById('wasteType');
      select.innerHTML = '';
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.ID;
        opt.textContent = t.–ù–∞–∑–≤–∞–Ω–∏–µ;
        select.appendChild(opt);
      });
    }

    async function addPoint() {
      const –ù–∞–∑–≤–∞–Ω–∏–µ = document.getElementById('name').value;
      const –ê–¥—Ä–µ—Å = document.getElementById('address').value;
      const msg = document.getElementById('message');

      if (!–ù–∞–∑–≤–∞–Ω–∏–µ.trim() || !–ê–¥—Ä–µ—Å.trim()) {
        msg.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        msg.style.color = 'red';
        return;
      }

      const res = await fetch('/api/points', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ –ù–∞–∑–≤–∞–Ω–∏–µ, –ê–¥—Ä–µ—Å, –®–∏—Ä–æ—Ç–∞: null, –î–æ–ª–≥–æ—Ç–∞: null })
      });

      if (res.ok) {
        msg.textContent = '‚úÖ –ü—É–Ω–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!';
        msg.style.color = '#90ee90';
        loadPoints();
      } else {
        msg.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏';
        msg.style.color = 'red';
      }
    }

    // –î—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∞

    async function loadReports() {
      const res = await fetch('/api/reports');
      const reports = await res.json();
      const table = document.getElementById('reportTable');
      table.innerHTML = '';
      reports.forEach(r => {
        const row = document.createElement('tr');
        row.innerHTML = ` 
          <td>${r.ID}</td>
          <td>${r.–ü–æ—á—Ç–∞}</td>
          <td>${r.–¢–∏–ø_–æ—Ç—Ö–æ–¥–∞}</td>
          <td>${r.–ü—É–Ω–∫—Ç}</td>
          <td>${r.–í–µ—Å_–≤_–∫–≥}</td>
          <td>${r.–î–∞—Ç–∞_—Å–¥–∞—á–∏.substring(0, 10)}</td>
        `;
        table.appendChild(row);
      });
    }

    async function loadRanking() {
      const res = await fetch('/api/ranking');
      const ranking = await res.json();
      const table = document.getElementById('rankingTable');
      table.innerHTML = '';
      ranking.forEach((user, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${user.–ü–æ—á—Ç–∞}</td>
          <td>${user.–í–∫–ª–∞–¥} –∫–≥</td>
        `;
        table.appendChild(row);
      });
    }
	async function addReport() {
      const –ü–æ—á—Ç–∞ = document.getElementById('userEmail').value;
      const –¢–∏–ø_–æ—Ç—Ö–æ–¥–∞_ID = parseInt(document.getElementById('wasteType').value);
      const –ü—É–Ω–∫—Ç_ID = parseInt(document.getElementById('recyclingPoint').value);
      const –í–µ—Å_–≤_–∫–≥ = parseFloat(document.getElementById('weight').value);
      const –î–∞—Ç–∞_—Å–¥–∞—á–∏ = document.getElementById('date').value;
      const msg = document.getElementById('reportMessage');

      const res = await fetch('/api/reports', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ –ü–æ—á—Ç–∞, –¢–∏–ø_–æ—Ç—Ö–æ–¥–∞_ID, –ü—É–Ω–∫—Ç_ID, –í–µ—Å_–≤_–∫–≥, –î–∞—Ç–∞_—Å–¥–∞—á–∏ })
      });

      if (res.ok) {
        msg.textContent = '‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!';
        msg.style.color = '#90ee90';
        loadReports();  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—á—ë—Ç—ã
      } else {
        msg.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ';
        msg.style.color = 'red';
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª–∞–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadVklad() {
      const email = document.getElementById('vkladEmail').value;
      const res = await fetch(`/api/vklad/${email}`);
      const data = await res.json();
      const out = document.getElementById('vkladResult');
      out.innerHTML = `‚ôªÔ∏è –°–¥–∞–Ω–æ –æ—Ç—Ö–æ–¥–æ–≤: <strong>${data.–≤–µ—Å} –∫–≥</strong><br>üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: <strong>${data.–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ}</strong>`;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É–Ω–∫—Ç–æ–≤
    async function loadPoints() {
      const res = await fetch('/api/points');
      const points = await res.json();
      const container = document.getElementById('points');
      const select = document.getElementById('recyclingPoint');
      container.innerHTML = '';
      select.innerHTML = '';
      points.forEach(p => {
        const div = document.createElement('div');
        div.className = 'point';
        div.innerHTML = `<strong>${p.–ù–∞–∑–≤–∞–Ω–∏–µ}</strong><br>${p.–ê–¥—Ä–µ—Å}`;
        container.appendChild(div);

        const opt = document.createElement('option');
        opt.value = p.ID;
        opt.textContent = p.–ù–∞–∑–≤–∞–Ω–∏–µ;
        select.appendChild(opt);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadPoints();
    setInterval(loadPoints, 5000);  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—É–Ω–∫—Ç—ã –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥


    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadPoints();
    loadWasteTypes();
    loadReports();
    loadRanking();
    setInterval(loadReports, 5000);  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—á—ë—Ç—ã –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(loadRanking, 5000);  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  </script>

</body>
</html>
